\chapter{Soluções \textit{Open Source} para Interoperabilidade}\label{cha:soluções}
	
	Como vimos no capítulo 2, existem diversos padrões para videoconferência. Padrões que desempenham a mesma função (sinalizar, transportar ou codificar) apresentam muitas propriedades em comum. Por exemplo, ambos SIP e H.323 definem mensagens que estabelecem e encerram chamadas, negociam mídias, etc. Protocolos de transporte em tempo real apresentam campos de \textit{timestamp}, mecanismos de identificação de dados (se mídia ou controle), entre outros. Portanto, não é surpresa que haja soluções que se propõem a fazer o meio de campo entre esses padrões, efetuando a tradução de um para outro. A seguir, então, veremos algumas soluções open source e quais problemas de interoperabilidade elas são capazes de resolver. Exploraremos com detalhes 3 soluções: Freeswitch, FFMPEG e Red5. Ao final do capítulo, ainda, são citadas mais duas soluções, visando trabalhos futuros: Asterisk e Kurento.
	
\section{Freeswitch}\label{sec:freeswitch}

    Freeswitch\footnote{\url{https://freeswitch.org/}} é um \textit{softswitch}. Um switch, no sentido de telefonia, é um dispositivo (hardware dedicado) de rede de telecomunicação que conecta e faz o roteamento de ligações. Um softswitch é um switch em software.
    
    As configurações do Freeswitch são definidas em arquivos XML. Dentre as inúmeras características do Freeswitch (FS), destacam-se:
    
	    \begin{itemize}
	        \item Configuração de \textit{dialplans}: Através de \textit{dialplans}, definimos as regras de ligações e de roteamentos. Por exemplo, podemos definir que as ligações que contêm 5 dígitos serão encaminhadas para uma sala de conferência, como define o dialplan da Figura~\ref{fig:fs-dialplan};
	        
	              \begin{figure}[h]
	            	 \centering
	            	 \caption{Exemplo de um \textit{dialplan} em XML.}
	            	 \includegraphics[width=29em, height=9em]{img/fs-dialplan.png}	            	 
	            	 \label{fig:fs-dialplan}
	               \end{figure} 
	               
	         \item Registro de usuários: Um exemplo de registro encontra-se na Figura~\ref{fig:fs-register}. Com esse tipo de recurso é possível, por exemplo, definir \textit{dialplans} onde o roteamento da ligação só ocorrerá se o usuário que está ligando ou sendo chamado for registrado;
	         
	               \begin{figure}[h]
	             	 \centering
	             	 \caption{Registo de usuário básico.}
	             	 \includegraphics[width=23em, height=6em]{img/fs-register.png}	             	 
	             	 \label{fig:fs-register}
	                \end{figure}      
	               
	    	\item Capacidade de conectar múltiplos participantes: através do \textit{mod\_conference}, módulo de conferência do FS (que será detalhado mais adiante), é possível que múltiplos usuários se conectem em uma sessão via SIP ou H.323. \textit{mod\_conference} irá administrar essa sessão, gerenciando os participantes e sendo um servidor de mídia, portanto, distribuindo áudio e vídeo entre o grupo de \textit{endpoints}. 
	    \end{itemize}
    
    O Freeswitch provê recursos para resolver os seguintes problemas de interoperabilidade:
    
    	\begin{itemize}
    	    \item \textbf{Conectar endpoints SIP e H.323}: Freeswitch tem 2 módulos específicos para lidar com endpoints SIP e H.323. \textit{mod\_sofia} é a implementação da camada SIP e \textit{mod\_h323}, a da camada H.323. A Figura~\ref{fig:fs-bridge} ilustra um exemplo de como acontece a ponte H.323/SIP.
    	    
    	    	 \begin{figure}[h]
    	    	    \centering
    	    	    \caption{Ponte H323-SIP do Freeswitch.}
    	    	    \includegraphics[width=32em, height=16em]{img/fs-bridge.png}    	    	    
    	    	    \label{fig:fs-bridge}
    	    	 \end{figure}
    	    	                
    	    Começamos com um endpoint H.323 ligando para o Freeswitch, pedindo para se conectar ao usuário \textit{fulano} (item 1 na figura). Quem lida com a ligação (e com todas as mensagens H.323) é o \textit{mod\_h323}. Após, este repassa o destino (\textit{fulano}) para o módulo responsável pelos \textit{dialplans}. O Freeswitch irá checar suas configurações e deverá encontrar um \textit{dialplan} com algum formato desse tipo (Figura~\ref{fig:fs-bridge-dialplan}): \\ \\ \\
    	    
     	    	 \begin{figure}[h]
     	    	    \centering
     	    	    \caption{Exemplo de \textit{dialplan} de redirecionamento SIP.}
     	    	    \includegraphics[width=25em, height=8em]{img/fs-bridge-dialplan.png}
     	    	    \label{fig:fs-bridge-dialplan}
     	    	 \end{figure} 	    
    	    
    	    Nele, o Freeswitch confirma que, se o destino for \textit{fulano}, ele deverá fazer uma ligação SIP para o IP 143.54.10.103 (item 2), realizada a partir do \textit{mod\_sofia}. A partir do momento em que \textit{fulano} aceita a ligação e ambos os \textit{endpoints} estão conectados, o Freeswitch recebe e repassa os dados de mídia para as partes envolvidas (3) via RTP, podendo haver transcodificação de codecs (o que veremos no próximo item).
    	       	    
    	    É graças a esse mecanismo que o \textit{mod\_conference} pode conectar endpoints SIP e H.323 na mesma sessão. Ao receber uma ligação SIP ou H.323, \textit{mod\_sofia} ou \textit{mod\_h323} redirecionam a chamada para o \textit{mod\_conference} através de um dialplan como o da Figura~\ref{fig:fs-dialplan}.
    	    
    		\item \textbf{Transcodificar codecs de áudio}: o Freeswitch é capaz de conectar usuários que não implementam os mesmos codecs de áudio. Se, ainda considerando a Figura~\ref{fig:fs-bridge}, o endpoint H.323, ao fazer a ligação, afirmasse via protocolo H.245 que só trabalha com áudio G.711, e o \textit{fulano}, ao aceitá-la, afirmasse via SDP que apenas implementa Speex, o Freeswitch conectaria os usuários realizando a transcodificação dos áudios. No exemplo, FS receberia áudio G.711, transcodificaria a mídia para Speex, e a repassaria para \textit{fulano}; da mesma forma, receberia Speex, transcodificaria tal codec para G.711, e repassaria o resultado para o endpoint H.323.
    		A lista de codecs de áudio que o FS é capaz de transcodificar é descrita no arquivo \textit{vars.xml}, que é o local onde há a declaração das variáveis usadas globalmente nas diversas configurações possíveis (dialplans, registro de usuários, entre outros). A lista completa está na Tabela~\ref{tab:fs-codecs-trans}. No mesmo arquivo, é listado os codecs que o Freeswitch não tem a capacidade de transcodificar (\textit{passthrough}), ou seja, o\\Freeswitch só tem a capacidade de repassar para os \textit{endpoints} as mídias que usam tais codecs. Basicamente, os codecs \textit{passthrough} do Freeswitch são os codecs de vídeo e também alguns poucos de áudio. A lista está na Tabela~\ref{tab:fs-codecs-no-trans}. \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\
    		
			   \begin{table}[h]
				\begin{center}
				 \caption{Lista de codecs que o Freeswitch é capaz de transcodificar.}
				 \resizebox{14cm}{!} {
				    \begin{tabular}{| c |}    \hline
				    \textbf{Lista de codecs transcodificáveis em \textit{vars.xml}}   \\ \hline \hline
				       \makecell[l]{opus@48000h@10i - Opus 48khz using 10 ms ptime (mono and stereo)} \\ \hline
				       \makecell[l]{opus@48000h@20i - Opus 48khz using 20 ms ptime (mono and stereo)} \\\hline
				       \makecell[l]{opus@48000h@40i - Opus 48khz using 40 ms ptime} \\ \hline
				       \makecell[l]{opus@8000h@10i - Opus 8khz using 10 ms ptime (mono and stereo)} \\ \hline
				       \makecell[l]{opus@8000h@20i - Opus 8khz using 20 ms ptime (mono and stereo)} \\ \hline
				       \makecell[l]{opus@8000h@40i - Opus 8khz using 40 ms ptime } \\ \hline
				       \makecell[l]{opus@8000h@60i - Opus 8khz using 60 ms ptime } \\ \hline
				       \makecell[l]{opus@8000h@80i - Opus 8khz using 80 ms ptime } \\ \hline
				       \makecell[l]{opus@8000h@100i - Opus 8khz using 100 ms ptime} \\ \hline
				       \makecell[l]{opus@8000h@120i - Opus 8khz using 120 ms ptime } \\ \hline					    
					   \makecell[l]{iLBC@30i         - iLBC using mode=30 which will win in all cases.}     \\ \hline
       				   \makecell[l]{DVI4@8000h@20i   - IMA ADPCM 8kHz using 20ms ptime. (multiples of 10)} \\ \hline
				       \makecell[l]{DVI4@16000h@40i  - IMA ADPCM 16kHz using 40ms ptime. (multiples of 10)} \\ \hline
				       \makecell[l]{speex@8000h@20i  - Speex 8kHz using 20ms ptime.} \\ \hline
				       \makecell[l]{speex@16000h@20i - Speex 16kHz using 20ms ptime.} \\\hline
				       \makecell[l]{speex@32000h@20i - Speex 32kHz using 20ms ptime.} \\ \hline
				       \makecell[l]{BV16             - BroadVoice 16kb/s narrowband, 8kHz} \\ \hline
				       \makecell[l]{BV32             - BroadVoice 32kb/s wideband, 16kHz} \\ \hline
				       \makecell[l]{G7221@16000h     - G722.1 16kHz (aka Siren 7)} \\ \hline
				       \makecell[l]{G7221@32000h     - G722.1C 32kHz (aka Siren 14)} \\ \hline
				       \makecell[l]{CELT@32000h      - CELT 32kHz, only 10ms supported} \\ \hline
				       \makecell[l]{CELT@48000h      - CELT 48kHz, only 10ms supported} \\ \hline       
				       \makecell[l]{GSM@40i          - GSM 8kHz using 40ms ptime. (GSM is done in multiples of 20, Default is 20ms)} \\ \hline
				       \makecell[l]{G722             - G722 16kHz using default 20ms ptime. (multiples of 10)} \\ \hline
				       \makecell[l]{PCMU             - G711 8kHz ulaw using default 20ms ptime. (multiples of 10)} \\ \hline
				       \makecell[l]{PCMA             - G711 8kHz alaw using default 20ms ptime. (multiples of 10)} \\ \hline
				       \makecell[l]{G726-16          - G726 16kbit adpcm using default 20ms ptime. (multiples of 10)} \\ \hline
				       \makecell[l]{G726-24          - G726 24kbit adpcm using default 20ms ptime. (multiples of 10)} \\ \hline
				       \makecell[l]{G726-32          - G726 32kbit adpcm using default 20ms ptime. (multiples of 10)} \\ \hline
				       \makecell[l]{G726-40          - G726 40kbit adpcm using default 20ms ptime. (multiples of 10)} \\ \hline
				       \makecell[l]{AAL2-G726-16     - Same as G726-16 but using AAL2 packing. (multiples of 10)}  \\ \hline
				       \makecell[l]{AAL2-G726-24     - Same as G726-24 but using AAL2 packing. (multiples of 10)} \\ \hline
				       \makecell[l]{AAL2-G726-32     - Same as G726-32 but using AAL2 packing. (multiples of 10)} \\ \hline
				       \makecell[l]{AAL2-G726-40     - Same as G726-40 but using AAL2 packing. (multiples of 10)} \\ \hline      
				       \makecell[l]{LPC              - LPC10 using 90ms ptime (only supports 90ms at this time in FreeSWITCH)} \\ \hline    
				       \makecell[l]{L16              - L16 isn't recommended for VoIP but you can do it. L16 can exceed the MTU rather quickly.} \\ \hline				
				    \end{tabular}}					
					\label{tab:fs-codecs-trans}
				 \end{center}
				\end{table}
    	
			   \begin{table}[H]
				\begin{center}
				 \caption{Lista de codecs que o Freeswitch não é capaz de transcodificar.}
				 \resizebox{8cm}{!} {
				    \begin{tabular}{| c |}    \hline
				    \textbf{Lista de codecs não transcodificáveis em \textit{vars.xml}}   \\ \hline \hline
					   \makecell[l]{G729             - G729 in passthru mode. (mod\_g729)}     \\ \hline
					   \makecell[l]{G723             - G723.1 in passthru mode. (mod\_g723\_1)}     \\ \hline							   
					   \makecell[l]{AMR              - AMR in passthru mode. (mod\_amr))}     \\ \hline
					   \makecell[l]{H261             - H.261 Video}     \\ \hline
					   \makecell[l]{H263             - H.263 Video}     \\ \hline							   
					   \makecell[l]{H263-1998        - H.263-1998 Video}     \\ \hline	
					   \makecell[l]{H263-2000        - H.263-2000 Video}     \\ \hline	
					   \makecell[l]{H264             - H.264 Video}     \\ \hline
					   \makecell[l]{VP8              - VP8 Video}     \\ \hline					  			   			   			
				    \end{tabular}}					
					\label{tab:fs-codecs-no-trans}
				 \end{center}
				\end{table}
				
			Apesar de dar suporte a todos os codecs acima (sejam \textit{passthrough} ou não), é possível configurar quais deles serão aceitos nas negociações SIP e H.323, através da variável \textit{global\_codec\_prefs} em \textit{vars.xml} (Figura~\ref{fig:fs-vars-codecs}).
			
			    \begin{figure}[h]
			     	\centering
					\caption{Exemplo da variável \textit{global\_codec\_prefs} em \textit{vars.xml}.}			     	
			     	\includegraphics[width=34em, height=2em]{img/fs-vars-codecs.png}
			     	\label{fig:fs-vars-codecs}
			     \end{figure} 
		\end{itemize}
		
      \subsection{\textit{mod\_conference}}\label{sec:fs-mod}
      
      	Como explicado anteriormente, \textit{mod\_conference} é o módulo de conferência do \\Freeswitch, capaz de conectar múltiplos usuários e de ser um servidor de mídia, distribuindo as mídias ativas entre os participantes de uma sessão.
      	
      	No exemplo de dialplan da Figura~\ref{fig:fs-dialplan}, quando o FS recebe uma ligação de 5 dígitos, ocorre o redirecionamento para uma sala de conferência. Quando um primeiro usuário liga, por exemplo, \textit{sip:12345@freeswitch-server-ip} e a chamada chega no Freeswitch, o dialplan, verificando que o número discado é de 5 dígitos, criará uma sala de conferência chamada \textit{12345} e conectará o usuário nessa sala. Todo endpoint que ligar posteriormente \textit{sip:12345@freeswitch-server-ip} ou \textit{h323:12345@freeswitch-server-ip} será direcionado para a sala \textit{12345}.
      	
      	Uma importante questão é a política do servidor de mídia para a distribuição desta entre o grupo conectado. O Freeswitch apresenta duas políticas distintas para áudio e vídeo.
      	
      	Para áudio, ocorre \textit{mixagem}. O exemplo da Figura~\ref{fig:fs-audio} demonstra o mecanismo dessa política.
      	
     	    	 \begin{figure}[h]
     	    	    \centering
     	    	    \caption{Mixagem de áudio do Freeswitch.}
     	    	    \includegraphics[width=32em, height=16em]{img/fs-audio.png}     	    	    
     	    	    \label{fig:fs-audio}
     	    	 \end{figure}     	
      
         No exemplo, temos quatro \textit{endpoints}: dois (User 1 e User 2) utilizando uma aplicação WebRTC (que permite que usuários se conectem no Freeswitch através do SIP.js, por exemplo), um \textit{endpoint} genérico SIP - equipamento ou softfone - (User 3), e outro \textit{endpoint} genérico H.323 (User 4). A mixagem de áudio no Freeswitch ocorre da seguinte maneira: o \textit{mod\_conference} recebe os pacotes de áudio do User 2, 3 e 4, transcodifica-os para OPUS, e executa a composição dos pacotes numa única \textit{stream} RTP chamada Mix 1. Após, o Mix 1 é transmitido para o User 1, que, desse modo, ouvirá todos os participantes, menos a si próprio. Assim ocorre com todos os demais participantes: User 2 recebe o Mix 2 em iLBC, composto dos áudios dos usuários 1,3,4 ; User 3 recebe o Mix 3 em Speex, composto dos áudios dos usuários 1,2,4 ; e, finalmente, User 4 recebe o Mix 4 em G.722, composto dos áudios dos usuários 1,2,3. \\  
         
         Para vídeo, ocorre \textit{switching}. O vídeo que é distribuído para o grupo é o vídeo do participante que está falando no momento, o chamado \textit{video floor}. No exemplo da Figura~\ref{fig:fs-video}, podemos ver o vídeo do User 1 sendo transmitido para todos os usuários (incluindo ele próprio). Portanto, o User 1 é o usuário com áudio ativo no momento.
         
      	    	 \begin{figure}[h]
      	    	    \centering
      	    	    \caption{\textit{Switching} de vídeo do Freeswitch.}
      	    	    \includegraphics[width=32em, height=16em]{img/fs-video.png}      	    	    
      	    	    \label{fig:fs-video}
      	    	 \end{figure}  
      	    	 
      \subsubsection{\textbf{Freeswitch 1.6}}\label{sec:fs-16}  
      
      À época do desenvolvimento deste trabalho, foi lançado o Freeswitch Versão 1.6, prevendo várias \textit{features} novas para a distribuição de vídeo, como:
      
      \begin{itemize}
          \item Composição de vídeo: o Freeswitch recebe os vídeos de todos os usuários e constrói uma \textit{stream} única de vídeo, em que seu conteúdo é a composição de todos os vídeos recebidos. Assim, é transmitida a mesma \textit{stream} de vídeo para os usuários. Cada um verá, dessa maneira, a imagem dos outros participantes e também a si mesmo. Um exemplo de composição é mostrado na Figura~\ref{fig:fs-composicao}.
      
      	    	 \begin{figure}[h]
      	    	    \centering
      	    	    \caption{Exemplo de composição de vídeo do Freeswitch.}
      	    	    \includegraphics[width=30em, height=14.7em]{img/fs-composicao.png}
      	    	    \footnotesize{ \\ Fonte: \cite{Freeswitch}.}
      	    	    \label{fig:fs-composicao}
      	    	 \end{figure} 
          
          \item Configuração de \textit{Layouts}: um vídeo composto pode dar ênfase a determinados vídeos através de \textit{layouts}, como pode ser visto na Figura~\ref{fig:fs-layout}.
          
          			 \begin{figure}[h]
          			 \centering
          			 \caption{Quatro exemplos de \textit{layouts} de vídeo do Freeswitch 1.6.}
          			 \subfigure{\includegraphics[width=5.2cm, height=8.7em]{img/fs-layout1.png}}
          			 \subfigure{\includegraphics[width=5.2cm, height=8.7em]{img/fs-layout2.png}}
          			 \subfigure{\includegraphics[width=5.2cm, height=8.7em]{img/fs-layout3.png}}
          			 \subfigure{\includegraphics[width=5.2cm, height=8.7em]{img/fs-layout4.png}}
          			 \footnotesize{ \\ Fonte: \cite{Freeswitch}.}
          			 \label{fig:fs-layout}
          			 \end{figure}
          			 
          \item Seleção de vídeos: Um usuário pode escolher qual vídeo, dentre os vídeos que o Freeswitch está recebendo no momento, ele quer visualizar.
      \end{itemize}
      
      Para mais informações, é possível acessar a página do Freeswitch 1.6 Video\footnote{\url{https://freeswitch.org/confluence/display/FREESWITCH/FreeSWITCH+1.6+Video}}.
      		 
\section{FFMPEG}\label{sec:ffmpeg}

   O projeto FFMPEG\footnote{\url{https://ffmpeg.org}} é um \textit{framework} multimídia, capaz de codificação, transcodificação, transmissão, análise e reprodução de áudio e vídeo. O projeto apresenta 4 ferramentas:
   
	   \begin{itemize}
	   	\item \textit{ffmpeg}\footnote{\url{https://ffmpeg.org/ffmpeg.html}}: ferramenta de linha de comando que tem a capacidade de converter mídias entre diferentes formatos;
	   	
	   	\item \textit{ffserver}\footnote{\url{https://ffmpeg.org/ffserver.html}}: servidor de mídia (recebimento e distribuição de áudio e vídeo);
	   	
	   	\item \textit{ffplay}\footnote{\url{https://ffmpeg.org/ffplay.html}}: player de mídia;
	   	
	   	\item \textit{ffprobe}\footnote{\url{https://ffmpeg.org/ffprobe.html}}: ferramenta que levanta dados de uma stream específica, como codecs usados, \textit{bitrate}, \textit{sample rate}, resolução, \textit{fps}, etc.
	   \end{itemize}
	   
	   Este trabalho focará na ferramenta \textit{ffmpeg}, visando resolver questões de interoperabilidade que o Freeswitch não prevê, que são:
	   
	   \begin{itemize}
		   	\item Transcodificação RTP/RTMP: esse passo é necessário para a interoperabilidade entre usuários Flash e não-Flash (ver também Seção~\ref{sec:red5});
		   	
		   	\item Transcodificação de vídeo: trocar o codec utilizado na \textit{stream} de vídeo. Por exemplo, receber uma \textit{stream} em VP8 e convertê-la para H.264.
	    \end{itemize}
	    	   	  	
	   	Um comando ffmpeg para transcodificação de \textit{streams} tem o seguinte formato (Figura~\ref{fig:ff-trans}):

			\begin{figure}[h]
			    \centering
			    \caption{Formato do comando \textit{ffmpeg}.}
			    \adjustbox{margin=1em,width=10.3cm,frame,center}
			    {\begin{minipage}{0.75\linewidth}
					\textit{ffmpeg -i <stream de entrada> <opções> <stream de saída>}
			    \end{minipage}}
				\label{fig:ff-trans}
			\end{figure}
			
		Primeiramente, colocamos o endereço da \textit{stream} que queremos transcodificar (\textit{stream} de entrada). Por exemplo, uma \textit{stream} de entrada poderia ser \textit{rtp://143.54.10.53:20881}. 
		
		Após, configuramos as opções do comando ffmpeg. Tais opções definem como o\\ffmpeg será executado e também os parâmetros da transcodificação. Por exemplo, podemos definir se queremos geração de logs, se estes serão impressos em tela ou em arquivo, o nível de detalhe do log que será gerado, entre outros. Já nas opções de transcodificação, descrevemos quais codecs serão utilizados, \textit{bitrates}, resolução, fps, etc (veremos em seguida).
		
		Finalmente, colocamos o endereço para onde a \textit{stream} transcodificada será transmitida. Poderíamos inserir algo como \textit{rtmp://143.54.10.103/video-sala-de-conferencia-3}, caso quiséssemos transcodificar uma \textit{stream} de entrada para RTMP.	
		
		A seguir, examinaremos dois exemplos de comandos de transcodificação:
		
		\begin{itemize}
			\item RTP para RTMP (Figura~\ref{fig:ff-RTP-RTMP}):
			
						\begin{figure}[h]
						    \centering
						    \caption{Comando \textit{ffmpeg} para transcodificação de RTP para RTMP.}
						    \adjustbox{margin=1em,width=13cm,frame,center}
						    {\begin{minipage}{0.75\linewidth}
								\textit{ffmpeg -i rtp://192.168.1.5:20646 \\
								  -vcodec libopenh264 -profile:v baseline -s 640x480\\
								  -r 15 -b:v 1024k -maxrate 1024k\\
								  "rtmp://192.168.1.5/video/sala-de-conferencia-3 live=1"}
						    \end{minipage}}						    
						    \label{fig:ff-RTP-RTMP}
						\end{figure}
						
						\begin{enumerate}
							\item O primeiro passo do comando é definir o \textit{input}. No caso, estamos utilizando uma \textit{stream} RTP rodando em 192.168.1.5, na porta 20646;
							
							\item O segundo é estabelecer o codec que será utilizado na transcodificação. No caso, estamos transcodificando a \textit{stream} para H.264 \textit{baseline} (\textit{-vcodec libopenh264 -profile:v baseline}). O comando utiliza a \textit{OpenH264}\footnote{\url{http://www.openh264.org/}}, biblioteca open source e de uso livre. A outra opção seria usar \textit{x264} (ficando: \textit{-vcodec h264 -profile:v baseline}). Essa opção é a biblioteca H.264 da VideoLAN\footnote{\url{http://www.videolan.org/developers/x264.html}}, também open source, porém para uso comercial é necessário o pagamento de royalties\footnote{\url{http://x264licensing.com/faq}}.
							
							Na configuração do \textit{vcodec}, poderíamos ter utilizado VP8 (\textit{-vcodec vp8}; por consequência, não utilizaríamos \textit{-profile:v baseline}), caso quiséssemos tal conversão.
							
							Se o desejado fosse não transcodificar o codec, a configuração seria: \textit{-vcodec copy}. Mesmo mantendo o mesmo codec, é possível alterar seus parâmetros, como é apresentado nos próximos itens. 
							
							Nesse exemplo (Figura~\ref{fig:ff-RTP-RTMP}), se assume que a \textit{stream} de entrada é uma \textit{stream} de vídeo. Caso tentássemos transcodificar uma \textit{stream} de áudio para H.264 - ou outro codec de vídeo - o comando ffmpeg geraria erro.
							
							\item Após, definimos que o vídeo transcodificado terá a resolução de 640x480 (\textit{-s 640x480}).
							
							\item Em seguida, estabelecemos parâmetros adicionais que serão usados na transcodificação: 15 \textit{fps} (\textit{-r 15}), \textit{bitrate} base de 1024kbps (\textit{-b:v 1024k}), com taxa máxima de, também, 1024kbps (\textit{-maxrate 1024k}); desse modo, definimos que o vídeo gerado será CBR.
							
							\item Finalmente, definimos o endereço para onde será transmitida a \textit{stream} transcodificada (\textit{"rtmp://192.168.1.5/video/sala-de-conferencia-3 live=1"}). Com esse endereço de saída, estamos informando ao ffmpeg que a \textit{stream} convertida para H.264 \textit{baseline} ainda deve sofrer mais uma transcodificação: de RTP para RTMP. A opção \textit{live=1} estabelece que a mídia da \textit{stream} RTMP não tem tamanho final definido (que é o caso das mídias de videoconferência: não há como saber qual o tamanho do áudio e do vídeo que serão transmitidos; a mídia existe enquanto durar a sessão de conferência).
							
							
						\end{enumerate}
						
			\item RTMP para RTP (Figura~\ref{fig:ff-RTMP-RTP}):
			
						\begin{figure}[h]
						    \centering
						    \caption{Comando \textit{ffmpeg} para transcodificação de RTMP para RTP.}
						    \adjustbox{margin=1em,width=13cm,frame,center}
						    {\begin{minipage}{0.85\linewidth}
								\textit{ffmpeg \\ -i "rtmp://192.168.1.5/video/sala-de-conferencia-3/video-usuario-6 live=1" \\
								-vcodec libopenh264 -profile:v baseline -r 15\\
								-payload\_type 97 -b:v 1024k -maxrate 1024k\\ 
								 rtp://192.168.1.5:18888}
						    \end{minipage}}						    
						    \label{fig:ff-RTMP-RTP}
						\end{figure}
						
				  O comando para o caminho contrário é semelhante. Porém, como esperado, a \textit{stream} de entrada	é uma \textit{stream} RTMP, e a de saída, RTP. Ainda definimos qual o valor do \textit{payload type} que os pacotes RTP gerados carregarão (\textit{-payload\_type 97}). Como pacotes RTP que transportam vídeo H.264 não tem \textit{payload type} pré-estabelecido (dinâmico), poderíamos ter definido qualquer valor entre 97 e 127 (como explicado na Seção~\ref{sec:rtp}).			
		\end{itemize} 
	   	   
    
\section{Red5}\label{sec:red5}

    O Red5\footnote{\url{http://red5.org/}} surgiu em 2005 como um servidor de mídia para Flash, e hoje cobre, também, outras tecnologias (como HLS, WebSockets, and RTSP). O Red5 é um meio importante, com a ajuda de outras soluções, para alcançar interoperabilidade de usuários Flash com outros tipos de endpoints. Isso por dois motivos.
    
    O primeiro é justamente ser um servidor de mídia para Flash open source e gratuíto. Sem uma opção desse tipo, depende-se da própria solução da Adobe, o Adobe Media Server, ferramenta paga e fechada. 
    
    Cada cliente Flash se conecta ao Red5 através de um \textit{NetConnection}. Uma vez conectados, usuários Flash enviam áudio e vídeo em RTMP. Red5 recebe cada uma das mídias e simplesmente as distribui para os outros clientes Flash (não fazendo mixagem ou \textit{switching}, por exemplo), de forma que cada cliente recebe múltiplas \textit{streams}. A Figura~\ref{fig:red5-midia} ilustra usuários Flash conectados em um servidor Red5, em que cada usuário manda sua mídia (linha colorida em direção ao Red5) e recebe as mídias dos demais usuários (representadas pelas cores de cada usuário).
    
      \begin{figure}[h]
    	 \centering
    	 \caption{Red5 como servidor de mídia Flash.}
    	 \includegraphics[width=26em, height=12em]{img/red5-midia.png}    	
    	 \label{fig:red5-midia}
       \end{figure} 
    
    O segundo motivo é a possibilidade de adicionar capacidades SIP e de transcodificação RTP/RTMP através do desenvolvimento de aplicações Red5, e, assim, interoperar com endpoints não-Flash. O Red5, nativamente, não suporta SIP. Porém, através da sua API em Java, o Red5 dá suporte a construção de aplicações, e nelas é possível estender as funcionalidades do servidor de mídia. Desse modo, podemos adicionar uma camada SIP. Existem soluções open source já consolidadas como o MjSip\footnote{\url{http://mjsip.org/index.html}} e o JAIN-SIP\footnote{\url{https://github.com/RestComm/jain-sip}}, ambas implementadas em Java.
    
    Red5Phone\footnote{\url{https://code.google.com/archive/p/red5phone/}} e Bigbluebutton\footnote{\url{http://bigbluebutton.org/}}, videoconferências open source que utilizam Red5, adicionaram o MjSip como aplicação Red5, incorporando, assim, uma camada SIP ao servidor de mídia Flash. O recomendado para uma camada SIP de um servidor Red5 é prever um mecanismo de transcodificação RTP/RTMP, visto que a grande maioria de endpoints SIP usam RTP. Os já mencionados Red5Phone e Bigbluebutton possuem um módulo na sua camada SIP que faz essa tradução (códigos próprios, escritos em Java). Alternativamente, poderia se utilizar o FFMPEG, como explicado na Seção~\ref{sec:ffmpeg}. 
    
    Assim, com uma camada SIP executando a transcodificação RTP/RTMP, o Red5 tem a capacidade de se conectar a um softswitch - como o Freeswitch -, transcodificar as mídias dos usuários Flash (RTMP para RTP) e transmiti-las para o softswitch. Este receberia as \textit{streams} e, de acordo com alguma política (por exemplo, mixando os áudios e selecionando o vídeo do falante, como ocorre no Freeswitch), encaminharia a mídia para os usuários SIP/H.323 conectados a ele. Da mesma forma, o softswitch receberia as mídias dos endpoints SIP/H.323 e as enviaria para o Red5, que, por sua vez, executaria a transcodificação de RTP para RTMP e distribuiria o resultado entre os clientes Flash.
    
    A Figura~\ref{fig:red5-fs} ilustra um exemplo de usuários Flash e não-Flash conectados através do Freeswitch e de um servidor Red5. Cada usuário Flash manda sua mídia para o Red5, e este distribui para os demais usuários Flash e também para o Freeswitch. Este, por sua vez, processa as mídias recebidas (mixagem ou \textit{switching}) e transmite o resultado para os \textit{endpoints} (flechas em amarelo). Também há o caminho contrário: os \textit{endpoints} enviam suas mídias para o Freeswitch, este as processa e transmite o resultado do processamento para o Red5 (flecha em preto) que, por sua vez, o distribui entre os usuários Flash. Lembrando que a troca de mídia entre Red5 e Freeswitch envolve transcodificação RTP/RTMP.
    
      \begin{figure}[h]
       	 \centering
       	 \caption{Red5 e Freeswitch conectando múltiplos usuários.}
       	 \includegraphics[width=35em, height=17em]{img/red5-fs.png}      	 
       	 \label{fig:red5-fs}
      \end{figure} 
   
    
    
\section{Outras Soluções para Trabalhos Futuros}\label{sec:outros}

	Foram levantadas algumas outras soluções open source que não serão detalhadas, ficando como sugestão a pesquisa destas para futuros trabalhos sobre interoperabilidade. Tais soluções são:
	
	   \begin{itemize}
	   	\item \textbf{Asterisk}\footnote{\url{http://www.asterisk.org/}}: pode atuar como um \textit{softswitch}, sendo uma alternativa ao Freeswitch. Em testes realizados, foi possível conectar \textit{endpoints} SIP e H.323 via áudio;
	   	
	   	\item \textbf{Kurento}\footnote{\url{https://www.kurento.org/}}: servidor de mídia WebRTC, onde clientes web se conectam via \textit{WebSocket}. Portanto, não é necessário o uso de bibliotecas como o SIP.js no lado do cliente. Diferentemente do Red5, o Kurento dá opções para a distribuição da mídia, onde o administrador do servidor pode habilitar o uso de mixagem de áudio ou de composição de vídeo. Assim como o Red5, é possível estender as funcionalidades do servidor de mídia através do desenvolvimento de aplicações Kurento. Dessa forma, pode-se adicionar uma camada SIP para a comunicação com \textit{softswitches} ou outros sistemas de videoconferência.
	   \end{itemize}	
	
	 
       